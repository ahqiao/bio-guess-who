<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bio Guess Who â€“ Live Multiplayer</title>
<style>
body { font-family: "Segoe UI", Arial, sans-serif; background:#f0f0f0; padding:10px; display:flex; justify-content:center; }
.card { background:#fff; padding:20px; border-radius:12px; width:500px; margin:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
h1 { color:#5c6bc0; }
button { background:#9575cd; color:white; border:none; border-radius:10px; padding:8px 12px; margin:5px; cursor:pointer; }
button:hover { background:#7e57c2; }
input { width:95%; padding:8px; margin:5px 0; border-radius:8px; border:1px solid #cfd8dc; }
#deductionBoard { display:grid; grid-template-columns: repeat(2, 1fr); gap:5px; margin-top:10px; max-height:200px; overflow-y:auto; }
.tile { padding:6px; border:1px solid #cfd8dc; border-radius:6px; text-align:center; cursor:pointer; background:#fafafa; transition:0.3s; display:flex; align-items:center; justify-content:center; min-height:40px; }
.tile.used { opacity:0.4; background:#ddd; pointer-events:none; }
#log { background:#f5f5f5; padding:10px; border-radius:6px; max-height:120px; overflow-y:auto; margin-top:10px; font-size:14px; }
.hidden { display:none; }
#rules { background:#e8eaf6; padding:10px; border-radius:8px; margin-bottom:10px; }
</style>
</head>
<body>

<div class="card" id="setup">
  <h1>ðŸ§¬ Bio Guess Who â€“ Live</h1>
  <div id="rules">
    <strong>Rules:</strong> Guess the opponent's word to win! Ask YES/NO questions to acquire hints. Maximum 10 rounds.
  </div>
  <input id="playerName" placeholder="Your Name">
  <input id="secretTerm" placeholder="Your secret term">
  <div style="font-size:12px; margin-bottom:5px;">Allowed terms for deduction board: Heart, Kidney, Liver, Lungs, Stomach, Intestine, Pancreas, Brain, Femur, Humerus, Skull, Rib, Vertebra, Clavicle, Tibia, Fibula, Amylase, Lipase, Pepsin, Trypsin, DNA Polymerase, Catalase, Lactase, Red Blood Cell, White Blood Cell, Neuron, Muscle Cell, Epithelial Cell, Sperm Cell, Egg Cell, Mitochondrion, Nucleus, Ribosome, Chloroplast</div>
  <button onclick="createRoom()">Create Game</button>
  <input id="roomCode" placeholder="Room code to join">
  <button onclick="joinRoom()">Join Game</button>
</div>

<div class="card hidden" id="game">
  <h2 id="turnText"></h2>
  <p>Round: <span id="round">1</span>/10</p>
  <input id="questionInput" placeholder="Ask a YES/NO question">
  <button onclick="askQuestion()">Ask Question</button>
  <p>Answer the question:</p>
  <button onclick="answer('YES')">YES</button>
  <button onclick="answer('NO')">NO</button>
  <h3>Deduction Board</h3>
  <div id="deductionBoard"></div>

  <div id="guessSection" class="hidden">
    <p>Make your guess!</p>
    <input id="guessInput" placeholder="Type your guess">
    <button onclick="submitGuess()">Submit Guess</button>
  </div>

  <button id="resetBtn" onclick="requestReset()">Reset Game</button>

  <div id="log"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ===== Firebase setup =====
const firebaseConfig = {
  apiKey: "AIzaSyAc3cG9ui8aN6aBOYU6Zg24t2RtX5l1uMo",
  authDomain: "guess-who-with-biology.firebaseapp.com",
  databaseURL: "https://guess-who-with-biology-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "guess-who-with-biology",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== Game variables =====
let room = null;
let player = null;
let secret = "";
let playerNumber = null;
let currentRound = 1;
const maxRounds = 10;
const tiles = [
  "Heart","Kidney","Liver","Lungs","Stomach","Intestine","Pancreas","Brain",
  "Femur","Humerus","Skull","Rib","Vertebra","Clavicle","Tibia","Fibula",
  "Amylase","Lipase","Pepsin","Trypsin","DNA Polymerase","Catalase","Lactase",
  "Red Blood Cell","White Blood Cell","Neuron","Muscle Cell","Epithelial Cell","Sperm Cell","Egg Cell","Mitochondrion","Nucleus","Ribosome","Chloroplast"
];

// ===== Setup functions =====
function createRoom(){
  player = document.getElementById("playerName").value.trim();
  secret = document.getElementById("secretTerm").value.trim();
  if(!player || !secret){ alert("Enter name and secret term!"); return; }
  room = Math.random().toString(36).substr(2,5).toUpperCase();
  playerNumber = 1;
  db.ref('rooms/'+room).set({
    p1Name: player,
    p1Secret: secret,
    p2Name: "",
    p2Secret: "",
    turn: 1,
    round: 1,
    question: "",
    answer: "",
    log: [],
    guesses: { p1:null, p2:null },
    resetRequest: null
  });
  alert("Game created! Room code: "+room);
  startGameUI();
}

function joinRoom(){
  player = document.getElementById("playerName").value.trim();
  secret = document.getElementById("secretTerm").value.trim();
  room = document.getElementById("roomCode").value.trim().toUpperCase();
  if(!player || !secret || !room){ alert("Enter name, secret term, and room code!"); return; }
  db.ref('rooms/'+room).get().then(snapshot=>{
    if(!snapshot.exists()){ alert("Room not found"); return; }
    const data = snapshot.val();
    if(data.p2Name){ alert("Room full!"); return; }
    playerNumber = 2;
    db.ref('rooms/'+room+'/p2Name').set(player);
    db.ref('rooms/'+room+'/p2Secret').set(secret);
    startGameUI();
  });
}

function startGameUI(){
  document.getElementById("setup").classList.add("hidden");
  document.getElementById("game").classList.remove("hidden");
  loadDeductionBoard();
  listenRoom();
}

// ===== Deduction Board =====
function loadDeductionBoard(){
  const board = document.getElementById("deductionBoard");
  board.innerHTML="";
  tiles.forEach(t=>{
    const div = document.createElement("div");
    div.className="tile";
    div.textContent = t;
    div.onclick = ()=>div.classList.toggle("used");
    board.appendChild(div);
  });
}

// ===== Real-time updates =====
function listenRoom(){
  db.ref('rooms/'+room).on('value', snapshot=>{
    const data = snapshot.val();
    if(!data) return;
    currentRound = data.round;
    document.getElementById("round").textContent = currentRound;
    const turnPlayer = data.turn===1?data.p1Name:data.p2Name;
    document.getElementById("turnText").textContent = "Turn: "+turnPlayer;

    // Show log
    const l = document.getElementById("log");
    l.innerHTML = "";
    if(data.log) data.log.forEach(m=>{ l.innerHTML += "<p>"+m+"</p>"; });

    // Show guess section if max rounds reached
    if(currentRound > maxRounds){
      document.getElementById("guessSection").classList.remove("hidden");
    }
  });

  // Listen for reset requests
  db.ref('rooms/'+room+'/resetRequest').on('value', snapshot => {
    const data = snapshot.val();
    if(!data) return;
    if(data.from === player) return; // ignore own request
    const accept = confirm(`Player ${data.from} requested to reset the game. Do you agree?`);
    if(accept) performReset();
    else db.ref('rooms/'+room+'/resetRequest').remove();
  });
}

// ===== Question/Answer =====
function askQuestion(){
  db.ref('rooms/'+room).get().then(snapshot=>{
    const data = snapshot.val();
    if(playerNumber !== data.turn){ alert("Not your turn"); return; }
    const q = document.getElementById("questionInput").value.trim();
    if(!q) return;
    db.ref('rooms/'+room).update({ question: q, answer: "" });
    db.ref('rooms/'+room+'/log').push(`Question: ${q}`);
    document.getElementById("questionInput").value="";
  });
}

function answer(ans){
  db.ref('rooms/'+room).get().then(snapshot=>{
    const data = snapshot.val();
    if(playerNumber === data.turn){ alert("Wait for opponent to ask"); return; }
    db.ref('rooms/'+room).update({ answer: ans });
    db.ref('rooms/'+room+'/log').push(`Answer: ${ans}`);
    endTurn();
  });
}

// ===== Turns =====
function endTurn(){
  currentRound++;
  db.ref('rooms/'+room+'/round').set(currentRound);
  db.ref('rooms/'+room).get().then(snapshot=>{
    const data = snapshot.val();
    const nextTurn = data.turn===1?2:1;
    db.ref('rooms/'+room+'/turn').set(nextTurn);
  });
}

// ===== Guessing =====
function submitGuess(){
  const guess = document.getElementById("guessInput").value.trim();
  if(!guess){ alert("Enter a guess!"); return; }

  const playerKey = playerNumber===1?'p1':'p2';
  db.ref('rooms/'+room+'/guesses/'+playerKey).set(guess).then(checkWinner);
  document.getElementById("guessInput").disabled = true;
  document.querySelector("#guessSection button").disabled = true;
}

function checkWinner(){
  db.ref('rooms/'+room).get().then(snapshot=>{
    const data = snapshot.val();
    if(!data.guesses.p1 || !data.guesses.p2) return; // wait for both guesses

    let winner = null;
    if(data.guesses.p1 === data.p2Secret && data.guesses.p2 === data.p1Secret){
      winner = "Both guessed correctly! It's a tie!";
    } else if(data.guesses.p1 === data.p2Secret){
      winner = `${data.p1Name} wins!`;
    } else if(data.guesses.p2 === data.p1Secret){
      winner = `${data.p2Name} wins!`;
    } else {
      winner = "No one guessed correctly. It's a tie!";
    }

    alert("Game Over! "+winner);
  });
}

// ===== Reset Game =====
function requestReset(){
  if(!confirm("Do you want to request a reset? Both players must confirm.")) return;
  db.ref('rooms/'+room+'/resetRequest').set({ from: player, timestamp: Date.now() });
}

function performReset(){
  db.ref('rooms/'+room).get().then(snapshot=>{
    const data = snapshot.val();
    if(!data) return;
    db.ref('rooms/'+room).update({
      turn: 1,
      round: 1,
      question: "",
      answer: "",
      log: [],
      guesses: { p1:null, p2:null },
      resetRequest: null
    });
    currentRound = 1;
    document.getElementById("round").textContent = currentRound;
    document.getElementById("log").innerHTML = "";
    document.querySelectorAll("#deductionBoard .tile").forEach(t => t.classList.remove("used"));
    document.getElementById("guessSection").classList.add("hidden");
    document.getElementById("guessInput").disabled = false;
    document.querySelector("#guessSection button").disabled = false;
    alert("Game has been reset! Start asking questions again.");
  });
}
</script>
</body>
</html>

